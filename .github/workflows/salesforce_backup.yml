name: Salesforce Backup

on:
  schedule:
    - cron: "0 2 * * *"  # Runs every day at 2 AM UTC
  workflow_dispatch:  # Allows manual triggering

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          echo "ğŸ”¹ Installing Salesforce CLI..."
          npm install --global sfdx-cli
          echo "âœ… Salesforce CLI installed."

      - name: Verify Salesforce CLI Installation
        run: |
          echo "ğŸ”¹ Checking Salesforce CLI version..."
          sfdx --version
          echo "ğŸ”¹ Checking installed plugins..."
          sfdx plugins --core

      - name: Authenticate with Salesforce
        env:
          SFDX_AUTH_URL: ${{ secrets.SALESFORCE_AUTH_URL }}
        run: |
          echo "ğŸ”¹ Authenticating with Salesforce..."
          echo "${SFDX_AUTH_URL}" > sfdx_auth.txt
          echo "ğŸ”¹ Storing authentication..."
          sfdx force:auth:sfdxurl:store -f sfdx_auth.txt -a personal-usage -d || { echo "âŒ Authentication failed"; exit 1; }
          rm sfdx_auth.txt
          echo "âœ… Authentication completed."
          echo "ğŸ”¹ Listing authenticated orgs..."
          sfdx force:auth:list

      - name: Check if package.xml exists
        run: |
          if [ ! -f manifest/package.xml ]; then
            echo "âŒ package.xml not found in manifest/ directory!"
            exit 1
          fi
          echo "âœ… package.xml found in manifest/."

      - name: Retrieve Metadata from Salesforce
        run: |
          echo "ğŸ”¹ Creating metadata directory..."
          mkdir -p metadata
          echo "ğŸ”¹ Retrieving metadata..."
          sfdx force:mdapi:retrieve -r ./metadata -u personal-usage -k manifest/package.xml || { echo "âŒ Metadata retrieval failed"; exit 1; }
          echo "âœ… Metadata retrieval completed."
          echo "ğŸ”¹ Extracting metadata..."
          unzip -o ./metadata/unpackaged.zip -d ./metadata/ || { echo "âŒ Metadata extraction failed"; exit 1; }
          echo "âœ… Metadata extracted."

      - name: Commit and Push Changes
        run: |
          echo "ğŸ”¹ Configuring Git..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          echo "ğŸ”¹ Adding changes to Git..."
          git add .
          echo "ğŸ”¹ Committing changes..."
          git commit -m "Automated Salesforce Backup - $(date +'%Y-%m-%d %H:%M:%S')" || echo "âœ… No changes to commit."
          echo "ğŸ”¹ Pushing changes to GitHub..."
          git push
          echo "âœ… Backup process completed successfully."
